import pandas as pd
from sklearn.metrics.pairwise import cosine_similarity
import numpy as np

# Read input CSV files
users = pd.read_csv("users.csv")
interactions = pd.read_csv("interactions.csv")

# Create user-item matrix
user_item_matrix = interactions.pivot_table(
    index='user_id', columns='product_id', values='rating'
).fillna(0)

#Compute user similarity matrix (Cosine Similarity)
similarity_matrix = cosine_similarity(user_item_matrix)
similarity_df = pd.DataFrame(
    similarity_matrix,
    index=user_item_matrix.index,
    columns=user_item_matrix.index
)

# Define recommendation function
def recommend_products(target_user_id, top_n_similar=3, top_k_products=5):
    if target_user_id not in similarity_df.index:
        print("User not found in dataset.")
        return []

    # Get top N similar users
    similar_users = similarity_df[target_user_id].sort_values(ascending=False)
    similar_users = similar_users.drop(target_user_id).head(top_n_similar).index.tolist()

    # Target user's existing products
    target_user_products = set(
        interactions.loc[interactions['user_id'] == target_user_id, 'product_id']
    )

    # Ratings from similar users
    similar_users_ratings = interactions[
        interactions['user_id'].isin(similar_users)
    ]

    # Average ratings per product from similar users
    product_mean_ratings = (
        similar_users_ratings.groupby('product_id')['rating'].mean().reset_index()
    )

    # Filter only high-rated products (> 4)
    recommended_products = product_mean_ratings[
        product_mean_ratings['rating'] > 4
    ]

    # Exclude products already rated by target user
    recommended_products = recommended_products[
        ~recommended_products['product_id'].isin(target_user_products)
    ]

    # Sort by rating and select top-k
    recommended_products = recommended_products.sort_values(
        'rating', ascending=False
    ).head(top_k_products)

    return recommended_products['product_id'].tolist()
